import { useState, useEffect, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { supabase } from "@/integrations/supabase/client";
import Header from "@/components/Layout/Header";
import Sidebar from "@/components/Layout/Sidebar";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Textarea } from "@/components/ui/textarea"; 
import {
  Select, SelectContent, SelectItem, SelectTrigger, SelectValue,
} from "@/components/ui/select";
import { useAuth } from "@/contexts/AuthContext";
import { toast } from "sonner";
import {
  Upload, Video, FileText, Users, CreditCard, CheckCircle, XCircle, Clock,
  BarChart3, Trash2, Plus, BookOpen, ExternalLink, ShieldAlert, Search,
  Download, Filter, RefreshCw, ChevronDown, Eye, IndianRupee, Loader2, ClipboardCheck, Library
} from "lucide-react";
import { ADMIN_CONFIG } from "@/lib/adminConfig";
import ContentDrillDown from "@/components/admin/ContentDrillDown";

// Types for users list
interface UserWithRole {
  id: string;
  full_name: string | null;
  email: string | null;
  mobile: string | null;
  created_at: string | null;
  role: string | null;
}

const Admin = () => {
  const navigate = useNavigate();
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const { user, isAdmin, isLoading: authLoading } = useAuth();
  const [activeTab, setActiveTab] = useState("payments");
  
  // -- DATA STATES --
  const [payments, setPayments] = useState<any[]>([]);
  const [lessons, setLessons] = useState<any[]>([]);
  const [coursesList, setCoursesList] = useState<any[]>([]);
  const [usersList, setUsersList] = useState<UserWithRole[]>([]);
  const [loading, setLoading] = useState(false);
  const [statsData, setStatsData] = useState({
    totalStudents: 0,
    totalCourses: 0,
    pendingPayments: 0,
    activeEnrollments: 0,
    totalRevenue: 0
  });

  // -- SEARCH & FILTER STATES (Notion-like) --
  const [paymentSearch, setPaymentSearch] = useState("");
  const [paymentStatusFilter, setPaymentStatusFilter] = useState<"pending" | "approved" | "rejected" | "all">("pending");
  const [courseSearch, setCourseSearch] = useState("");
  const [lessonSearch, setLessonSearch] = useState("");
  const [lessonTypeFilter, setLessonTypeFilter] = useState<"all" | "VIDEO" | "PDF" | "DPP" | "NOTES" | "TEST">("all");
  const [userSearch, setUserSearch] = useState("");
  const [userRoleFilter, setUserRoleFilter] = useState<"all" | "student" | "teacher" | "admin">("all");

  // -- COURSE CREATION STATE --
  const [newCourse, setNewCourse] = useState({
    title: "", description: "", price: "", grade: "",
  });
  const [isCreatingCourse, setIsCreatingCourse] = useState(false);
  const [thumbnailFile, setThumbnailFile] = useState<File | null>(null);

  // -- UPLOAD STATE --
  const [uploadType, setUploadType] = useState<"video" | "pdf" | "dpp" | "notes" | "test">("video");
  const [videoUrl, setVideoUrl] = useState("");
  const [videoTitle, setVideoTitle] = useState("");
  const [selectedCourse, setSelectedCourse] = useState("");
  const [selectedChapter, setSelectedChapter] = useState("");
  const [chaptersList, setChaptersList] = useState<any[]>([]);
  const [uploadMode, setUploadMode] = useState<"link" | "file">("link");
  const [contentDescription, setContentDescription] = useState("");
  const [watermarkText, setWatermarkText] = useState("Mahima Academy");
  const [pdfFile, setPdfFile] = useState<File | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  
  // -- INLINE EDIT STATE --
  const [editingCourseId, setEditingCourseId] = useState<number | null>(null);
  const [editCourseData, setEditCourseData] = useState({ title: "", description: "", price: "", grade: "" });
  const [editingLessonId, setEditingLessonId] = useState<string | null>(null);
  const [editLessonData, setEditLessonData] = useState<{
    title: string; video_url: string; lecture_type: string; chapter_id: string;
    description: string; position: string; is_locked: boolean; thumbnail_url: string;
  }>({ title: "", video_url: "", lecture_type: "VIDEO", chapter_id: "", description: "", position: "0", is_locked: false, thumbnail_url: "" });

  // Library/Notes state
  const [materialsList, setMaterialsList] = useState<any[]>([]);
  const [notesList, setNotesList] = useState<any[]>([]);
  const [newMaterial, setNewMaterial] = useState({ title: "", description: "", file_url: "", course_id: "" });
  const [newNote, setNewNote] = useState({ title: "", pdf_url: "", lesson_id: "" });
  const [editingMaterialId, setEditingMaterialId] = useState<string | null>(null);
  const [editMaterialData, setEditMaterialData] = useState({ title: "", description: "", file_url: "" });
  const [editingNoteId, setEditingNoteId] = useState<string | null>(null);
  const [editNoteData, setEditNoteData] = useState({ title: "", pdf_url: "" });

  // Admin access protection with email verification
  useEffect(() => {
    if (!authLoading && !user) {
      toast.error("Please login to access admin panel");
      navigate("/admin/login");
    } else if (!authLoading && user) {
      // SECURITY: Check if user email is the authorized admin
      if (!ADMIN_CONFIG.isAuthorizedAdmin(user.email)) {
        toast.error("Access denied. This account is not authorized for admin access.");
        navigate("/dashboard");
        return;
      }
      if (!isAdmin) {
        toast.error("Access denied. Admin privileges required.");
        navigate("/dashboard");
      }
    }
  }, [user, isAdmin, authLoading, navigate]);

  useEffect(() => {
    if (user && isAdmin) {
      fetchDashboardData();
    }
  }, [paymentStatusFilter, user, isAdmin]);

  // Fetch chapters when selected course changes
  useEffect(() => {
    const fetchChapters = async () => {
      if (!selectedCourse) { setChaptersList([]); return; }
      const { data } = await supabase
        .from('chapters')
        .select('*')
        .eq('course_id', Number(selectedCourse))
        .order('position', { ascending: true });
      setChaptersList(data || []);
    };
    fetchChapters();
  }, [selectedCourse]);

  // --- 1. FETCH DATA ---
  const fetchDashboardData = async () => {
    setLoading(true);
    try {
      // A. Fetch Courses
      const { data: coursesData } = await supabase.from('courses').select('*');
      if (coursesData) setCoursesList(coursesData);

      // B. Fetch Payments (With User Profile & Course Details)
      let paymentQuery = supabase
        .from('payment_requests')
        .select(`*, courses (title), profiles (full_name, email)`)
        .order('created_at', { ascending: false });
      
      if (paymentStatusFilter !== "all") {
        paymentQuery = paymentQuery.eq('status', paymentStatusFilter);
      }
        
      const { data: payData, error: payError } = await paymentQuery;
      if (payData) setPayments(payData);
      if (payError) console.error("Payment Fetch Error:", payError);

      // C. Fetch Lessons
      const { data: lessonData } = await supabase
        .from('lessons')
        .select(`*, courses (title)`).order('created_at', { ascending: false });
      if (lessonData) setLessons(lessonData);

      // D. Fetch Users with Roles (join profiles and user_roles)
      const { data: profilesData } = await supabase
        .from('profiles')
        .select('*');
      
      const { data: rolesData } = await supabase
        .from('user_roles')
        .select('user_id, role');
      
      if (profilesData) {
        const usersWithRoles: UserWithRole[] = profilesData.map(profile => ({
          id: profile.id,
          full_name: profile.full_name,
          email: profile.email,
          mobile: profile.mobile,
          created_at: profile.created_at,
          role: rolesData?.find(r => r.user_id === profile.id)?.role || null
        }));
        setUsersList(usersWithRoles);
      }

      // E. Stats - Count students from user_roles table
      const { count: studentCount } = await supabase
        .from('user_roles')
        .select('*', { count: 'exact', head: true })
        .eq('role', 'student');
      
      const { count: enrollCount } = await supabase
        .from('enrollments')
        .select('*', { count: 'exact', head: true });
      
      const { count: pendingCount } = await supabase
        .from('payment_requests')
        .select('*', { count: 'exact', head: true })
        .eq('status', 'pending');

      // F. Calculate Total Revenue from approved payments
      const { data: approvedPayments } = await supabase
        .from('payment_requests')
        .select('amount')
        .eq('status', 'approved');
      
      const totalRevenue = approvedPayments?.reduce((sum, p) => sum + (p.amount || 0), 0) || 0;

      setStatsData({
        totalStudents: studentCount || 0,
        totalCourses: coursesData?.length || 0,
        pendingPayments: pendingCount || 0,
        activeEnrollments: enrollCount || 0,
        totalRevenue
      });

    } catch (error) {
      console.error("Error fetching admin data:", error);
      toast.error("Failed to load dashboard data");
    } finally {
      setLoading(false);
    }
  };

  // --- FILTERED DATA (Notion-like search) ---
  const filteredPayments = useMemo(() => {
    return payments.filter(p => {
      const searchLower = paymentSearch.toLowerCase();
      return (
        (p.sender_name?.toLowerCase().includes(searchLower) || "") ||
        (p.transaction_id?.toLowerCase().includes(searchLower) || "") ||
        (p.profiles?.full_name?.toLowerCase().includes(searchLower) || "") ||
        (p.profiles?.email?.toLowerCase().includes(searchLower) || "") ||
        (p.courses?.title?.toLowerCase().includes(searchLower) || "")
      );
    });
  }, [payments, paymentSearch]);

  const filteredCourses = useMemo(() => {
    return coursesList.filter(c => 
      c.title?.toLowerCase().includes(courseSearch.toLowerCase()) ||
      c.grade?.toLowerCase().includes(courseSearch.toLowerCase())
    );
  }, [coursesList, courseSearch]);

  const filteredLessons = useMemo(() => {
    return lessons.filter(l => {
      const matchesSearch = l.title?.toLowerCase().includes(lessonSearch.toLowerCase()) ||
        l.courses?.title?.toLowerCase().includes(lessonSearch.toLowerCase());
      const matchesType = lessonTypeFilter === "all" || l.lecture_type === lessonTypeFilter;
      return matchesSearch && matchesType;
    });
  }, [lessons, lessonSearch, lessonTypeFilter]);

  // Filtered Users
  const filteredUsers = useMemo(() => {
    return usersList.filter(u => {
      const matchesSearch = 
        u.full_name?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.email?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.mobile?.toLowerCase().includes(userSearch.toLowerCase());
      const matchesRole = userRoleFilter === "all" || u.role === userRoleFilter;
      return matchesSearch && matchesRole;
    });
  }, [usersList, userSearch, userRoleFilter]);

  // --- EXPORT TO CSV ---
  const exportToCSV = (data: any[], filename: string) => {
    if (data.length === 0) {
      toast.error("No data to export");
      return;
    }
    
    const headers = Object.keys(data[0]).filter(k => !k.includes('id') && typeof data[0][k] !== 'object');
    const csvContent = [
      headers.join(','),
      ...data.map(row => 
        headers.map(h => {
          const val = row[h];
          if (typeof val === 'string' && val.includes(',')) return `"${val}"`;
          return val ?? '';
        }).join(',')
      )
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    toast.success(`Exported ${data.length} records`);
  };

  // --- 2. PAYMENT APPROVAL LOGIC (MAIN) ---
  const handleApprovePayment = async (paymentRequest: any) => {
    if(!confirm(`Approve payment of ₹${paymentRequest.amount} for ${paymentRequest.sender_name}?`)) return;

    try {
      // Step A: Update Payment Status
      const { error: updateError } = await supabase
        .from('payment_requests')
        .update({ status: 'approved' })
        .eq('id', paymentRequest.id);

      if (updateError) throw updateError;

      // Step B: Check if already enrolled (to avoid duplicates)
      const { data: existingEnroll } = await supabase
        .from('enrollments')
        .select('*')
        .eq('user_id', paymentRequest.user_id)
        .eq('course_id', paymentRequest.course_id)
        .maybeSingle();

      // Step C: Enroll Student if not already enrolled
      if (!existingEnroll) {
        const { error: enrollError } = await supabase
          .from('enrollments')
          .insert({
            user_id: paymentRequest.user_id,
            course_id: paymentRequest.course_id
          });
        if (enrollError) throw enrollError;
      }

      toast.success("Payment Approved & Course Unlocked!");
      fetchDashboardData();

    } catch (error: any) {
      toast.error("Approval Error: " + error.message);
    }
  };

  // --- 3. PAYMENT REJECTION LOGIC ---
  const handleRejectPayment = async (paymentId: number) => {
    if(!confirm("Are you sure you want to REJECT this payment?")) return;
    
    try {
      const { error } = await supabase
        .from('payment_requests')
        .update({ status: 'rejected' })
        .eq('id', paymentId);

      if (error) throw error;
      toast.error("Payment request rejected.");
      fetchDashboardData();
    } catch (error: any) {
      toast.error("Error rejecting: " + error.message);
    }
  };

  // --- 4. COURSE MANAGEMENT ---
  const handleCreateCourse = async () => {
    if (!newCourse.title || !newCourse.price || !newCourse.grade) return toast.error("Fill all fields");
    try {
      setIsCreatingCourse(true);
      
      let thumbnailUrl = "https://placehold.co/600x400/png";
      
      if (thumbnailFile) {
        const fileExt = thumbnailFile.name.split('.').pop();
        const fileName = `course_${Date.now()}.${fileExt}`;
        const { error: uploadError } = await supabase.storage
          .from('content')
          .upload(`thumbnails/${fileName}`, thumbnailFile);
        if (uploadError) throw uploadError;
        const { data: { publicUrl } } = supabase.storage
          .from('content')
          .getPublicUrl(`thumbnails/${fileName}`);
        thumbnailUrl = publicUrl;
      }
      
      const { error } = await supabase.from('courses').insert({
        title: newCourse.title,
        description: newCourse.description,
        price: parseFloat(newCourse.price),
        grade: newCourse.grade,
        image_url: thumbnailUrl,
        thumbnail_url: thumbnailUrl,
      });
      if (error) throw error;
      toast.success("Course Created!");
      setNewCourse({ title: "", description: "", price: "", grade: "" });
      setThumbnailFile(null);
      fetchDashboardData();
    } catch (error: any) {
      toast.error(error.message);
    } finally {
      setIsCreatingCourse(false);
    }
  };

  const handleDeleteCourse = async (id: number) => {
    if (!confirm("Delete course? This will remove all lessons too!")) return;
    const { error } = await supabase.from('courses').delete().eq('id', id);
    if (error) toast.error(error.message);
    else { toast.success("Course deleted"); fetchDashboardData(); }
  };

  // --- 5. CONTENT UPLOAD (with chapter, link/file toggle) ---
  const handleContentUpload = async () => {
    if (!videoTitle || !selectedCourse) return toast.error("Fill title and select course");
    
    setIsUploading(true);
    try {
      let contentUrl = "";
      
      if (uploadMode === "file" && pdfFile) {
        const fileExt = pdfFile.name.split('.').pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
        const filePath = `lessons/${fileName}`;
        
        const { error: uploadError } = await supabase.storage
          .from('content')
          .upload(filePath, pdfFile);
        
        if (uploadError) throw uploadError;
        
        const { data: { publicUrl } } = supabase.storage
          .from('content')
          .getPublicUrl(filePath);
        
        contentUrl = publicUrl;
      } else {
        contentUrl = videoUrl;
      }

      if (!contentUrl) return toast.error("Provide a URL or upload a file");

      const lectureTypeMap: Record<string, string> = {
        video: "VIDEO",
        pdf: "PDF",
        dpp: "DPP",
        notes: "NOTES",
        test: "TEST",
      };

      const insertData: any = {
        course_id: parseInt(selectedCourse),
        title: videoTitle,
        video_url: contentUrl,
        lecture_type: lectureTypeMap[uploadType],
        description: contentDescription || `${uploadType.toUpperCase()} content`,
        is_locked: true,
      };
      
      if (selectedChapter) {
        insertData.chapter_id = selectedChapter;
      }

      const { error } = await supabase.from('lessons').insert(insertData);
      
      if (error) throw error;
      toast.success("Content Added!");
      setVideoTitle(""); 
      setVideoUrl(""); 
      setSelectedCourse("");
      setSelectedChapter("");
      setContentDescription("");
      setPdfFile(null);
      fetchDashboardData();
    } catch (error: any) {
      toast.error(error.message);
    } finally {
      setIsUploading(false);
    }
  };

  const handleDeleteLesson = async (id: string) => {
    if(!confirm("Delete lesson?")) return;
    const { error } = await supabase.from('lessons').delete().eq('id', id);
    if(!error) { toast.success("Deleted"); fetchDashboardData(); }
  };

  // --- INLINE EDIT: Course ---
  const handleEditCourse = (course: any) => {
    setEditingCourseId(course.id);
    setEditCourseData({
      title: course.title || "",
      description: course.description || "",
      price: String(course.price || ""),
      grade: course.grade || "",
    });
  };

  const handleSaveCourseEdit = async () => {
    if (!editingCourseId) return;
    const { error } = await supabase.from('courses').update({
      title: editCourseData.title,
      description: editCourseData.description,
      price: parseFloat(editCourseData.price) || 0,
      grade: editCourseData.grade,
    }).eq('id', editingCourseId);
    if (error) toast.error(error.message);
    else { toast.success("Course updated!"); setEditingCourseId(null); fetchDashboardData(); }
  };

  // --- INLINE EDIT: Lesson (ALL parameters) ---
  const handleEditLesson = (lesson: any) => {
    setEditingLessonId(lesson.id);
    setEditLessonData({
      title: lesson.title || "",
      video_url: lesson.video_url || "",
      lecture_type: lesson.lecture_type || "VIDEO",
      chapter_id: lesson.chapter_id || "",
      description: lesson.description || "",
      position: String(lesson.position || 0),
      is_locked: lesson.is_locked || false,
      thumbnail_url: lesson.thumbnail_url || "",
    });
    // Fetch chapters for lesson's course
    if (lesson.course_id) {
      supabase.from('chapters').select('*').eq('course_id', lesson.course_id).order('position').then(({ data }) => {
        setChaptersList(data || []);
      });
    }
  };

  const handleSaveLessonEdit = async () => {
    if (!editingLessonId) return;
    const { error } = await supabase.from('lessons').update({
      title: editLessonData.title,
      video_url: editLessonData.video_url,
      lecture_type: editLessonData.lecture_type,
      chapter_id: editLessonData.chapter_id || null,
      description: editLessonData.description || null,
      position: parseInt(editLessonData.position) || 0,
      is_locked: editLessonData.is_locked,
    }).eq('id', editingLessonId);
    if (error) toast.error(error.message);
    else { toast.success("Lesson updated!"); setEditingLessonId(null); fetchDashboardData(); }
  };

  // --- Library & Notes CRUD ---
  const fetchLibraryData = async () => {
    const { data: mats } = await supabase.from('materials').select('*, courses(title)').order('created_at', { ascending: false });
    if (mats) setMaterialsList(mats);
    const { data: nts } = await supabase.from('notes').select('*, lessons(title)').order('created_at', { ascending: false });
    if (nts) setNotesList(nts);
  };

  const handleCreateMaterial = async () => {
    if (!newMaterial.title || !newMaterial.file_url) return toast.error("Title and URL required");
    const { error } = await supabase.from('materials').insert({
      title: newMaterial.title,
      description: newMaterial.description || null,
      file_url: newMaterial.file_url,
      file_type: newMaterial.file_url.match(/\.(\w+)($|\?)/)?.[1]?.toUpperCase() || 'PDF',
      course_id: newMaterial.course_id ? parseInt(newMaterial.course_id) : null,
    });
    if (error) toast.error(error.message);
    else { toast.success("Material added!"); setNewMaterial({ title: "", description: "", file_url: "", course_id: "" }); fetchLibraryData(); }
  };

  const handleDeleteMaterial = async (id: string) => {
    if (!confirm("Delete this material?")) return;
    const { error } = await supabase.from('materials').delete().eq('id', id);
    if (!error) { toast.success("Deleted"); fetchLibraryData(); }
  };

  const handleSaveMaterialEdit = async () => {
    if (!editingMaterialId) return;
    const { error } = await supabase.from('materials').update({
      title: editMaterialData.title, description: editMaterialData.description, file_url: editMaterialData.file_url,
    }).eq('id', editingMaterialId);
    if (error) toast.error(error.message);
    else { toast.success("Updated!"); setEditingMaterialId(null); fetchLibraryData(); }
  };

  const handleCreateNote = async () => {
    if (!newNote.title || !newNote.pdf_url) return toast.error("Title and PDF URL required");
    const { error } = await supabase.from('notes').insert({
      title: newNote.title,
      pdf_url: newNote.pdf_url,
      lesson_id: newNote.lesson_id || null,
    });
    if (error) toast.error(error.message);
    else { toast.success("Note added!"); setNewNote({ title: "", pdf_url: "", lesson_id: "" }); fetchLibraryData(); }
  };

  const handleDeleteNote = async (id: string) => {
    if (!confirm("Delete this note?")) return;
    const { error } = await supabase.from('notes').delete().eq('id', id);
    if (!error) { toast.success("Deleted"); fetchLibraryData(); }
  };

  const handleSaveNoteEdit = async () => {
    if (!editingNoteId) return;
    const { error } = await supabase.from('notes').update({
      title: editNoteData.title, pdf_url: editNoteData.pdf_url,
    }).eq('id', editingNoteId);
    if (error) toast.error(error.message);
    else { toast.success("Updated!"); setEditingNoteId(null); fetchLibraryData(); }
  };

  // Stats UI Config with tab navigation targets
  const stats = [
    { label: "Total Students", value: statsData.totalStudents, icon: Users, color: "text-blue-600 bg-blue-100", tab: "users" },
    { label: "Total Revenue", value: `₹${statsData.totalRevenue.toLocaleString()}`, icon: IndianRupee, color: "text-emerald-600 bg-emerald-100", tab: "payments" },
    { label: "Total Courses", value: statsData.totalCourses, icon: BookOpen, color: "text-green-600 bg-green-100", tab: "courses" },
    { label: "Pending Payments", value: statsData.pendingPayments, icon: Clock, color: "text-orange-600 bg-orange-100", tab: "payments" },
    { label: "Active Enrollments", value: statsData.activeEnrollments, icon: CheckCircle, color: "text-purple-600 bg-purple-100", tab: "" },
  ];


  // Role badge helper
  const getRoleBadge = (role: string | null) => {
    switch(role) {
      case 'admin': return <Badge className="bg-red-100 text-red-700 border-red-200">Admin</Badge>;
      case 'teacher': return <Badge className="bg-blue-100 text-blue-700 border-blue-200">Teacher</Badge>;
      case 'student': return <Badge className="bg-green-100 text-green-700 border-green-200">Student</Badge>;
      default: return <Badge className="bg-gray-100 text-gray-700 border-gray-200">No Role</Badge>;
    }
  };

  // Status badge helper
  const getStatusBadge = (status: string) => {
    switch(status) {
      case 'approved': return <Badge className="bg-green-100 text-green-700 border-green-200">Approved</Badge>;
      case 'rejected': return <Badge className="bg-red-100 text-red-700 border-red-200">Rejected</Badge>;
      default: return <Badge className="bg-yellow-100 text-yellow-700 border-yellow-200">Pending</Badge>;
    }
  };

  // Show loading or access denied
  // Loading state with timeout indicator
  const [loadTimeout, setLoadTimeout] = useState(false);
  
  useEffect(() => {
    if (authLoading) {
      const timer = setTimeout(() => setLoadTimeout(true), 8000);
      return () => clearTimeout(timer);
    } else {
      setLoadTimeout(false);
    }
  }, [authLoading]);

  if (authLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="h-12 w-12 animate-spin text-primary mx-auto mb-4" />
          <p className="text-gray-500">
            {loadTimeout ? "Taking longer than expected..." : "Loading..."}
          </p>
          {loadTimeout && (
            <button 
              onClick={() => window.location.reload()}
              className="mt-4 text-primary hover:underline text-sm font-medium"
            >
              Refresh Page
            </button>
          )}
        </div>
      </div>
    );
  }

  if (!user || !isAdmin) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <Card className="max-w-md w-full mx-4">
          <CardContent className="p-8 text-center">
            <ShieldAlert className="h-16 w-16 text-red-500 mx-auto mb-4" />
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Access Denied</h2>
            <p className="text-gray-500 mb-6">You need admin privileges to access this page.</p>
            <Button onClick={() => navigate("/admin/login")} className="w-full">
              Go to Admin Login
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <Sidebar isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} />
      <Header onMenuClick={() => setSidebarOpen(true)} />

      <main className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
        
        {/* Title with Refresh */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
            <p className="text-gray-500">Manage your academy operations securely.</p>
          </div>
          <Button variant="outline" onClick={fetchDashboardData} disabled={loading}>
            <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
        </div>

        {/* Stats Grid */}
        <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
          {stats.map((stat) => (
            <Card
              key={stat.label}
              className={`border-none shadow-sm ${stat.tab ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}`}
              onClick={() => { if (stat.tab) setActiveTab(stat.tab); }}
            >
              <CardContent className="p-4 flex items-center gap-4">
                <div className={`p-3 rounded-xl ${stat.color}`}>
                  <stat.icon className="h-6 w-6" />
                </div>
                <div>
                  <p className="text-2xl font-bold text-gray-900">{stat.value}</p>
                  <p className="text-sm text-gray-500 font-medium">{stat.label}</p>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* TABS SECTION */}
        <Tabs value={activeTab} onValueChange={(v) => { setActiveTab(v); if (v === 'library') fetchLibraryData(); }} className="w-full space-y-6">
          <TabsList className="bg-white p-1 border rounded-lg w-full md:w-auto grid grid-cols-6 h-auto">
            <TabsTrigger value="payments" className="py-2">Payments <Badge variant="destructive" className="ml-2">{statsData.pendingPayments}</Badge></TabsTrigger>
            <TabsTrigger value="users" className="py-2">Users</TabsTrigger>
            <TabsTrigger value="courses" className="py-2">Courses</TabsTrigger>
            <TabsTrigger value="content" className="py-2">Content</TabsTrigger>
            <TabsTrigger value="upload" className="py-2">Upload</TabsTrigger>
            <TabsTrigger value="library" className="py-2"><Library className="h-4 w-4 mr-1" />Library</TabsTrigger>
          </TabsList>

          {/* --- TAB 1: PAYMENTS (with Notion-like features) --- */}
          <TabsContent value="payments">
            <Card className="border shadow-sm">
              <CardHeader className="bg-orange-50/50 border-b pb-4">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <CardTitle className="flex items-center gap-2 text-orange-700">
                    <ShieldAlert className="h-5 w-5" />
                    Payment Requests
                  </CardTitle>
                  <div className="flex flex-wrap items-center gap-2">
                    {/* Search */}
                    <div className="relative flex-1 min-w-[200px]">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                      <Input 
                        placeholder="Search by name, UTR, email..." 
                        value={paymentSearch}
                        onChange={(e) => setPaymentSearch(e.target.value)}
                        className="pl-9 bg-white"
                      />
                    </div>
                    {/* Filter */}
                    <Select value={paymentStatusFilter} onValueChange={(v: any) => setPaymentStatusFilter(v)}>
                      <SelectTrigger className="w-[130px] bg-white">
                        <Filter className="h-4 w-4 mr-2" />
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Status</SelectItem>
                        <SelectItem value="pending">Pending</SelectItem>
                        <SelectItem value="approved">Approved</SelectItem>
                        <SelectItem value="rejected">Rejected</SelectItem>
                      </SelectContent>
                    </Select>
                    {/* Export */}
                    <Button variant="outline" size="sm" onClick={() => exportToCSV(filteredPayments.map(p => ({
                      sender_name: p.sender_name,
                      transaction_id: p.transaction_id,
                      amount: p.amount,
                      status: p.status,
                      course: p.courses?.title,
                      user: p.profiles?.full_name,
                      email: p.profiles?.email,
                      created_at: p.created_at
                    })), 'payments')}>
                      <Download className="h-4 w-4 mr-1" /> Export
                    </Button>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="p-0">
                <ScrollArea className="h-[500px]">
                  {filteredPayments.length === 0 ? (
                    <div className="text-center py-12">
                      <CheckCircle className="h-12 w-12 text-green-500 mx-auto mb-3 opacity-20" />
                      <p className="text-muted-foreground">No payment requests found.</p>
                    </div>
                  ) : (
                    <div className="divide-y">
                      {filteredPayments.map((req) => (
                        <div key={req.id} className="p-4 md:p-6 hover:bg-gray-50 transition-colors flex flex-col md:flex-row gap-6">
                          
                          {/* Left: Info */}
                          <div className="flex-1 space-y-2">
                            <div className="flex justify-between items-start">
                              <div>
                                <div className="flex items-center gap-2">
                                  <h3 className="font-bold text-lg text-gray-900">{req.courses?.title || "Unknown Course"}</h3>
                                  {getStatusBadge(req.status)}
                                </div>
                                <p className="text-sm text-gray-500">
                                  App User: <span className="font-medium text-gray-700">{req.profiles?.full_name || "N/A"}</span> ({req.profiles?.email})
                                </p>
                              </div>
                              <Badge variant="outline" className="text-lg px-3 py-1 bg-green-50 text-green-700 border-green-200">
                                ₹{req.amount}
                              </Badge>
                            </div>

                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 text-sm space-y-1">
                              <p className="flex justify-between">
                                <span className="text-blue-600 font-medium">Bank Sender Name:</span>
                                <span className="font-bold text-gray-800">{req.sender_name || "Not Provided"}</span>
                              </p>
                              <p className="flex justify-between">
                                <span className="text-blue-600 font-medium">UTR / Ref No:</span>
                                <span className="font-mono font-bold text-gray-800">{req.transaction_id}</span>
                              </p>
                            </div>
                          </div>

                          {/* Right: Actions & Proof */}
                          <div className="flex flex-col gap-3 min-w-[200px]">
                             {/* Screenshot Button */}
                             {req.screenshot_url ? (
                               <a 
                                 href={req.screenshot_url} 
                                 target="_blank" 
                                 rel="noopener noreferrer"
                                 className="w-full"
                               >
                                 <Button variant="outline" className="w-full border-dashed border-gray-400 text-gray-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300">
                                   <Eye className="h-4 w-4 mr-2" /> View Screenshot
                                 </Button>
                               </a>
                             ) : (
                               <div className="text-xs text-red-500 text-center py-2 bg-red-50 rounded">No Screenshot</div>
                             )}

                             {req.status === 'pending' && (
                               <div className="flex gap-2 mt-auto">
                                 <Button 
                                   className="flex-1 bg-green-600 hover:bg-green-700 text-white" 
                                   onClick={() => handleApprovePayment(req)}
                                 >
                                   <CheckCircle className="h-4 w-4 mr-1" /> Approve
                                 </Button>
                                 <Button 
                                   variant="destructive" 
                                   className="flex-1" 
                                   onClick={() => handleRejectPayment(req.id)}
                                 >
                                   <XCircle className="h-4 w-4 mr-1" /> Reject
                                 </Button>
                               </div>
                             )}
                          </div>

                        </div>
                      ))}
                    </div>
                  )}
                </ScrollArea>
              </CardContent>
            </Card>
          </TabsContent>

          {/* --- TAB 2: USERS (with search & role filter) --- */}
          <TabsContent value="users">
            <Card className="border shadow-sm">
              <CardHeader className="bg-blue-50/50 border-b pb-4">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <CardTitle className="flex items-center gap-2 text-blue-700">
                    <Users className="h-5 w-5" />
                    Registered Users ({usersList.length})
                  </CardTitle>
                  <div className="flex flex-wrap items-center gap-2">
                    {/* Search */}
                    <div className="relative flex-1 min-w-[200px]">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                      <Input 
                        placeholder="Search by name, email, phone..." 
                        value={userSearch}
                        onChange={(e) => setUserSearch(e.target.value)}
                        className="pl-9 bg-white"
                      />
                    </div>
                    {/* Role Filter */}
                    <Select value={userRoleFilter} onValueChange={(v: any) => setUserRoleFilter(v)}>
                      <SelectTrigger className="w-[130px] bg-white">
                        <Filter className="h-4 w-4 mr-2" />
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Roles</SelectItem>
                        <SelectItem value="student">Student</SelectItem>
                        <SelectItem value="teacher">Teacher</SelectItem>
                        <SelectItem value="admin">Admin</SelectItem>
                      </SelectContent>
                    </Select>
                    {/* Export */}
                    <Button variant="outline" size="sm" onClick={() => exportToCSV(filteredUsers.map(u => ({
                      full_name: u.full_name,
                      email: u.email,
                      mobile: u.mobile,
                      role: u.role,
                      created_at: u.created_at
                    })), 'users')}>
                      <Download className="h-4 w-4 mr-1" /> Export
                    </Button>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="p-0">
                <ScrollArea className="h-[500px]">
                  {filteredUsers.length === 0 ? (
                    <div className="text-center py-12">
                      <Users className="h-12 w-12 text-blue-500 mx-auto mb-3 opacity-20" />
                      <p className="text-muted-foreground">No users found.</p>
                    </div>
                  ) : (
                    <div className="divide-y">
                      {filteredUsers.map((u) => (
                        <div key={u.id} className="p-4 md:p-5 hover:bg-gray-50 transition-colors flex items-center gap-4">
                          {/* Avatar */}
                          <div className="h-12 w-12 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center text-blue-600 font-bold text-lg flex-shrink-0">
                            {u.full_name?.charAt(0)?.toUpperCase() || u.email?.charAt(0)?.toUpperCase() || '?'}
                          </div>
                          
                          {/* Info */}
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 flex-wrap">
                              <h3 className="font-semibold text-gray-900 truncate">
                                {u.full_name || 'Unnamed User'}
                              </h3>
                              {getRoleBadge(u.role)}
                            </div>
                            <p className="text-sm text-gray-500 truncate">{u.email}</p>
                            {u.mobile && (
                              <p className="text-xs text-gray-400">{u.mobile}</p>
                            )}
                          </div>
                          
                          {/* Joined Date */}
                          <div className="text-right text-sm text-gray-400 hidden md:block">
                            <p>Joined</p>
                            <p className="font-medium text-gray-600">
                              {new Date(u.created_at).toLocaleDateString('en-IN', { 
                                day: 'numeric', 
                                month: 'short', 
                                year: 'numeric' 
                              })}
                            </p>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </ScrollArea>
              </CardContent>
            </Card>
          </TabsContent>

          {/* --- TAB 3: COURSES (with search & export) --- */}
          <TabsContent value="courses">
            <div className="grid md:grid-cols-2 gap-6">
              <Card>
                <CardHeader><CardTitle>Create Course</CardTitle></CardHeader>
                <CardContent className="space-y-4">
                  <div className="space-y-2">
                    <Label>Title</Label>
                    <Input value={newCourse.title} onChange={(e) => setNewCourse({...newCourse, title: e.target.value})} placeholder="Class 10 Science" />
                  </div>
                  <div className="space-y-2">
                    <Label>Description</Label>
                    <Textarea value={newCourse.description} onChange={(e) => setNewCourse({...newCourse, description: e.target.value})} placeholder="Details..." />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label>Price (₹)</Label>
                      <Input type="number" value={newCourse.price} onChange={(e) => setNewCourse({...newCourse, price: e.target.value})} placeholder="499" />
                    </div>
                    <div className="space-y-2">
                      <Label>Grade</Label>
                      <Input value={newCourse.grade} onChange={(e) => setNewCourse({...newCourse, grade: e.target.value})} placeholder="10" />
                    </div>
                  </div>
                  <div className="space-y-2">
                    <Label>Course Thumbnail</Label>
                    <div className="border-2 border-dashed rounded-lg p-4 text-center">
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => setThumbnailFile(e.target.files?.[0] || null)}
                        className="hidden"
                        id="thumbnail-upload"
                      />
                      <label htmlFor="thumbnail-upload" className="cursor-pointer">
                        {thumbnailFile ? (
                          <div className="flex items-center justify-center gap-2 text-green-600">
                            <Eye className="h-5 w-5" />
                            <span className="font-medium text-sm">{thumbnailFile.name}</span>
                          </div>
                        ) : (
                          <div className="text-gray-500 text-sm">
                            <Upload className="h-6 w-6 mx-auto mb-1 text-gray-400" />
                            <p>Click to upload thumbnail image</p>
                          </div>
                        )}
                      </label>
                    </div>
                  </div>
                  <Button className="w-full" onClick={handleCreateCourse} disabled={isCreatingCourse}>
                    {isCreatingCourse ? <Clock className="animate-spin mr-2"/> : <Plus className="mr-2 h-4 w-4"/>} Create Course
                  </Button>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <CardTitle>Course List</CardTitle>
                    <Button variant="outline" size="sm" onClick={() => exportToCSV(filteredCourses.map(c => ({
                      title: c.title,
                      description: c.description,
                      price: c.price,
                      grade: c.grade,
                      created_at: c.created_at
                    })), 'courses')}>
                      <Download className="h-4 w-4 mr-1" /> Export
                    </Button>
                  </div>
                  <div className="relative mt-2">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input 
                      placeholder="Search courses..." 
                      value={courseSearch}
                      onChange={(e) => setCourseSearch(e.target.value)}
                      className="pl-9"
                    />
                  </div>
                </CardHeader>
                <CardContent>
                  <ScrollArea className="h-[350px]">
                    <div className="space-y-3">
                      {filteredCourses.map((c) => (
                        <div key={c.id} className="p-3 border rounded-lg bg-white space-y-2">
                          {editingCourseId === c.id ? (
                            <div className="space-y-2">
                              <Input value={editCourseData.title} onChange={(e) => setEditCourseData({...editCourseData, title: e.target.value})} placeholder="Title" />
                              <Textarea value={editCourseData.description} onChange={(e) => setEditCourseData({...editCourseData, description: e.target.value})} placeholder="Description" rows={2} />
                              <div className="grid grid-cols-2 gap-2">
                                <Input value={editCourseData.price} onChange={(e) => setEditCourseData({...editCourseData, price: e.target.value})} placeholder="Price" type="number" />
                                <Input value={editCourseData.grade} onChange={(e) => setEditCourseData({...editCourseData, grade: e.target.value})} placeholder="Grade" />
                              </div>
                              <div className="flex gap-2">
                                <Button size="sm" onClick={handleSaveCourseEdit}><CheckCircle className="h-3 w-3 mr-1" /> Save</Button>
                                <Button size="sm" variant="ghost" onClick={() => setEditingCourseId(null)}>Cancel</Button>
                              </div>
                            </div>
                          ) : (
                            <div className="flex justify-between items-center">
                              <div>
                                <p className="font-semibold">{c.title}</p>
                                <p className="text-xs text-muted-foreground">₹{c.price} • Grade {c.grade}</p>
                              </div>
                              <div className="flex items-center gap-1">
                                <Button size="icon" variant="ghost" className="text-blue-500 hover:bg-blue-50" onClick={() => handleEditCourse(c)}>
                                  <Eye className="h-4 w-4"/>
                                </Button>
                                <Button size="icon" variant="ghost" className="text-red-500 hover:bg-red-50" onClick={() => handleDeleteCourse(c.id)}>
                                  <Trash2 className="h-4 w-4"/>
                                </Button>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                      {filteredCourses.length === 0 && (
                        <p className="text-center text-gray-400 py-10">No courses found.</p>
                      )}
                    </div>
                  </ScrollArea>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* --- TAB 3: CONTENT (Drill-down: Course > Chapter > Lessons) --- */}
          <TabsContent value="content">
            <ContentDrillDown
              coursesList={coursesList}
              onNavigateToUpload={(courseId, chapterId) => {
                setSelectedCourse(courseId);
                if (chapterId) setSelectedChapter(chapterId);
                setActiveTab("upload");
              }}
              onRefresh={fetchDashboardData}
            />
          </TabsContent>

          {/* --- TAB 4: UPLOAD (with chapter, link/file toggle, description) --- */}
          <TabsContent value="upload">
            <Card>
              <CardHeader><CardTitle>Upload New Material</CardTitle></CardHeader>
              <CardContent className="space-y-5">
                {/* Content Type Selector */}
                <div className="grid grid-cols-2 sm:grid-cols-5 gap-2">
                  <Button variant={uploadType==="video"?"default":"outline"} onClick={()=>{setUploadType("video"); setUploadMode("link");}} className="flex-1">
                    <Video className="h-4 w-4 mr-2" /> Lecture
                  </Button>
                  <Button variant={uploadType==="pdf"?"default":"outline"} onClick={()=>setUploadType("pdf")} className="flex-1">
                    <FileText className="h-4 w-4 mr-2" /> PDF
                  </Button>
                  <Button variant={uploadType==="dpp"?"default":"outline"} onClick={()=>setUploadType("dpp")} className="flex-1">
                    <FileText className="h-4 w-4 mr-2" /> DPP
                  </Button>
                  <Button variant={uploadType==="notes"?"default":"outline"} onClick={()=>setUploadType("notes")} className="flex-1">
                    <BookOpen className="h-4 w-4 mr-2" /> Notes
                  </Button>
                  <Button variant={uploadType==="test"?"default":"outline"} onClick={()=>{setUploadType("test"); setUploadMode("link");}} className="flex-1">
                    <ClipboardCheck className="h-4 w-4 mr-2" /> Test
                  </Button>
                </div>
                
                {/* Title */}
                <div className="space-y-2">
                  <Label>Title *</Label>
                  <Input value={videoTitle} onChange={(e)=>setVideoTitle(e.target.value)} placeholder="Content Title" />
                </div>

                {/* Description */}
                <div className="space-y-2">
                  <Label>Description (Optional)</Label>
                  <Textarea value={contentDescription} onChange={(e)=>setContentDescription(e.target.value)} placeholder="Brief description of this content..." rows={2} />
                </div>

                {/* Link vs File Toggle (for non-video types) */}
                {uploadType !== "video" && uploadType !== "test" && (
                  <div className="flex items-center gap-2">
                    <Button size="sm" variant={uploadMode==="link"?"default":"outline"} onClick={()=>setUploadMode("link")}>
                      <ExternalLink className="h-3 w-3 mr-1" /> Paste Link
                    </Button>
                    <Button size="sm" variant={uploadMode==="file"?"default":"outline"} onClick={()=>setUploadMode("file")}>
                      <Upload className="h-3 w-3 mr-1" /> Upload File
                    </Button>
                  </div>
                )}

                {/* URL Input */}
                {(uploadMode === "link" || uploadType === "video" || uploadType === "test") && (
                  <div className="space-y-2">
                    <Label>
                      {uploadType === "video" ? "Video URL (YouTube/Vimeo/Archive.org/Drive)" : 
                       uploadType === "test" ? "Test URL (External Link)" : 
                       "Content URL (Google Drive / External Link)"}
                    </Label>
                    <Input value={videoUrl} onChange={(e)=>setVideoUrl(e.target.value)} placeholder="https://..." />
                  </div>
                )}

                {/* File Upload */}
                {uploadMode === "file" && uploadType !== "video" && uploadType !== "test" && (
                  <div className="space-y-2">
                    <Label>{uploadType === "dpp" ? "DPP File" : uploadType === "notes" ? "Notes File" : "PDF File"}</Label>
                    <div className="border-2 border-dashed rounded-lg p-6 text-center">
                      <input
                        type="file"
                        accept=".pdf,.doc,.docx"
                        onChange={(e) => setPdfFile(e.target.files?.[0] || null)}
                        className="hidden"
                        id="file-upload"
                      />
                      <label htmlFor="file-upload" className="cursor-pointer">
                        {pdfFile ? (
                          <div className="flex items-center justify-center gap-2 text-green-600">
                            <FileText className="h-6 w-6" />
                            <span className="font-medium">{pdfFile.name}</span>
                          </div>
                        ) : (
                          <div className="text-gray-500">
                            <Upload className="h-8 w-8 mx-auto mb-2 text-gray-400" />
                            <p>Click to upload file</p>
                          </div>
                        )}
                      </label>
                    </div>
                  </div>
                )}

                {/* Video Preview */}
                {uploadType === "video" && videoUrl && (() => {
                  const extractYouTubeId = (url: string): string | null => {
                    const patterns = [
                      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                      /^([a-zA-Z0-9_-]{11})$/,
                    ];
                    for (const pattern of patterns) {
                      const match = url.match(pattern);
                      if (match) return match[1];
                    }
                    return null;
                  };
                  const youtubeId = extractYouTubeId(videoUrl);
                  
                  if (youtubeId) {
                    return (
                      <div className="space-y-2">
                        <Label className="flex items-center gap-2 text-green-600">
                          <Eye className="h-4 w-4" />
                          Live Preview
                        </Label>
                        <div className="relative rounded-lg overflow-hidden border-2 border-green-200 bg-black">
                          <div className="aspect-video">
                            <iframe
                              src={`https://www.youtube-nocookie.com/embed/${youtubeId}?modestbranding=1&rel=0&showinfo=0&iv_load_policy=3&disablekb=1`}
                              allowFullScreen
                              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                              className="w-full h-full border-0"
                              title="Video Preview"
                            />
                          </div>
                          <div className="absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full font-medium">
                            🔒 Ghost Mode
                          </div>
                        </div>
                      </div>
                    );
                  }
                  return null;
                })()}

                {/* Course Selection */}
                <div className="space-y-2">
                  <Label>Select Course *</Label>
                  <Select value={selectedCourse} onValueChange={(v) => { setSelectedCourse(v); setSelectedChapter(""); }}>
                    <SelectTrigger><SelectValue placeholder="Select Course" /></SelectTrigger>
                    <SelectContent>
                      {coursesList.map(c => <SelectItem key={c.id} value={c.id.toString()}>{c.title}</SelectItem>)}
                    </SelectContent>
                  </Select>
                </div>

                {/* Chapter Selection (shown when course is selected and chapters exist) */}
                {selectedCourse && chaptersList.length > 0 && (
                  <div className="space-y-2">
                    <Label>Select Chapter (Optional)</Label>
                    <Select value={selectedChapter} onValueChange={setSelectedChapter}>
                      <SelectTrigger><SelectValue placeholder="No Chapter (Root Level)" /></SelectTrigger>
                      <SelectContent>
                        <SelectItem value="">No Chapter (Root Level)</SelectItem>
                        {chaptersList.map(ch => <SelectItem key={ch.id} value={ch.id}>{ch.title}</SelectItem>)}
                      </SelectContent>
                    </Select>
                  </div>
                )}

                {/* Watermark */}
                <div className="space-y-2">
                  <Label>Watermark Text</Label>
                  <Input value={watermarkText} onChange={(e)=>setWatermarkText(e.target.value)} placeholder="Mahima Academy" />
                </div>

                <Button className="w-full" onClick={handleContentUpload} disabled={isUploading}>
                  {isUploading ? <Clock className="animate-spin mr-2"/> : <Upload className="mr-2 h-4 w-4"/>} 
                  Publish Content
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* --- TAB 6: LIBRARY & NOTES --- */}
          <TabsContent value="library">
            <div className="grid md:grid-cols-2 gap-6">
              {/* Materials Section */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2"><FileText className="h-5 w-5" /> Materials (PDF / Links)</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="space-y-3 border rounded-lg p-4 bg-muted/30">
                    <Input value={newMaterial.title} onChange={(e) => setNewMaterial({...newMaterial, title: e.target.value})} placeholder="Material title *" />
                    
                    {/* Upload Mode Toggle */}
                    <div className="flex items-center gap-2">
                      <Button size="sm" variant={!pdfFile ? "default" : "outline"} onClick={() => setPdfFile(null)}>
                        <ExternalLink className="h-3 w-3 mr-1" /> Paste Link
                      </Button>
                      <Button size="sm" variant={pdfFile ? "default" : "outline"} onClick={() => {
                        document.getElementById('library-file-upload')?.click();
                      }}>
                        <Upload className="h-3 w-3 mr-1" /> Upload PDF
                      </Button>
                    </div>

                    {/* Link Input */}
                    {!pdfFile && (
                      <Input value={newMaterial.file_url} onChange={(e) => setNewMaterial({...newMaterial, file_url: e.target.value})} placeholder="Google Drive / Supabase Storage URL" />
                    )}

                    {/* File Upload */}
                    <input
                      type="file"
                      accept=".pdf,.doc,.docx"
                      id="library-file-upload"
                      className="hidden"
                      onChange={(e) => {
                        const file = e.target.files?.[0];
                        if (file) setPdfFile(file);
                      }}
                    />
                    {pdfFile && (
                      <div className="flex items-center gap-2 p-2 bg-green-50 rounded border border-green-200 text-sm text-green-700">
                        <FileText className="h-4 w-4" />
                        <span className="font-medium truncate">{pdfFile.name}</span>
                        <Button size="sm" variant="ghost" className="ml-auto h-6 text-red-500" onClick={() => setPdfFile(null)}>✕</Button>
                      </div>
                    )}

                    <Textarea value={newMaterial.description} onChange={(e) => setNewMaterial({...newMaterial, description: e.target.value})} placeholder="Description (optional)" rows={2} />
                    <Select value={newMaterial.course_id} onValueChange={(v) => setNewMaterial({...newMaterial, course_id: v})}>
                      <SelectTrigger><SelectValue placeholder="Link to Course (optional)" /></SelectTrigger>
                      <SelectContent>
                        <SelectItem value="">No Course</SelectItem>
                        {coursesList.map(c => <SelectItem key={c.id} value={c.id.toString()}>{c.title}</SelectItem>)}
                      </SelectContent>
                    </Select>
                    <Button size="sm" className="w-full" onClick={async () => {
                      if (pdfFile) {
                        // Upload to Supabase storage first
                        const fileExt = pdfFile.name.split('.').pop();
                        const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                        const filePath = `materials/${fileName}`;
                        const { error: uploadError } = await supabase.storage.from('content').upload(filePath, pdfFile);
                        if (uploadError) { toast.error(uploadError.message); return; }
                        const { data: { publicUrl } } = supabase.storage.from('content').getPublicUrl(filePath);
                        setNewMaterial(prev => ({ ...prev, file_url: publicUrl }));
                        // Wait for state then create
                        await supabase.from('materials').insert({
                          title: newMaterial.title,
                          description: newMaterial.description || null,
                          file_url: publicUrl,
                          file_type: fileExt?.toUpperCase() || 'PDF',
                          course_id: newMaterial.course_id ? parseInt(newMaterial.course_id) : null,
                        });
                        toast.success("Material uploaded!");
                        setPdfFile(null);
                        setNewMaterial({ title: "", description: "", file_url: "", course_id: "" });
                        fetchLibraryData();
                      } else {
                        handleCreateMaterial();
                      }
                    }}>
                      <Plus className="h-3 w-3 mr-1" /> {pdfFile ? "Upload & Add Material" : "Add Material"}
                    </Button>
                  </div>

                  <ScrollArea className="h-[350px]">
                    <div className="space-y-2">
                      {materialsList.map((m) => (
                        <div key={m.id} className="p-3 border rounded bg-white">
                          {editingMaterialId === m.id ? (
                            <div className="space-y-2">
                              <Input value={editMaterialData.title} onChange={(e) => setEditMaterialData({...editMaterialData, title: e.target.value})} />
                              <Input value={editMaterialData.file_url} onChange={(e) => setEditMaterialData({...editMaterialData, file_url: e.target.value})} />
                              <Textarea value={editMaterialData.description} onChange={(e) => setEditMaterialData({...editMaterialData, description: e.target.value})} rows={2} />
                              <div className="flex gap-2">
                                <Button size="sm" onClick={handleSaveMaterialEdit}><CheckCircle className="h-3 w-3 mr-1" /> Save</Button>
                                <Button size="sm" variant="ghost" onClick={() => setEditingMaterialId(null)}>Cancel</Button>
                              </div>
                            </div>
                          ) : (
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="font-medium text-sm">{m.title}</p>
                                <p className="text-xs text-muted-foreground">{m.courses?.title || "No course"} • {m.file_type}</p>
                              </div>
                              <div className="flex gap-1">
                                <Button size="icon" variant="ghost" onClick={() => { setEditingMaterialId(m.id); setEditMaterialData({ title: m.title, description: m.description || "", file_url: m.file_url }); }}>
                                  <Eye className="h-4 w-4" />
                                </Button>
                                <Button size="icon" variant="ghost" className="text-red-400" onClick={() => handleDeleteMaterial(m.id)}>
                                  <Trash2 className="h-4 w-4" />
                                </Button>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                      {materialsList.length === 0 && <p className="text-center text-muted-foreground py-8">No materials yet.</p>}
                    </div>
                  </ScrollArea>
                </CardContent>
              </Card>

              {/* Notes Section */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2"><BookOpen className="h-5 w-5" /> Notes</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="space-y-2 border rounded-lg p-3 bg-muted/30">
                    <Input value={newNote.title} onChange={(e) => setNewNote({...newNote, title: e.target.value})} placeholder="Note title" />
                    <Input value={newNote.pdf_url} onChange={(e) => setNewNote({...newNote, pdf_url: e.target.value})} placeholder="PDF URL" />
                    <Select value={newNote.lesson_id} onValueChange={(v) => setNewNote({...newNote, lesson_id: v})}>
                      <SelectTrigger><SelectValue placeholder="Link to Lesson (optional)" /></SelectTrigger>
                      <SelectContent>
                        <SelectItem value="">No Lesson</SelectItem>
                        {lessons.slice(0, 50).map(l => <SelectItem key={l.id} value={l.id}>{l.title}</SelectItem>)}
                      </SelectContent>
                    </Select>
                    <Button size="sm" onClick={handleCreateNote}><Plus className="h-3 w-3 mr-1" /> Add Note</Button>
                  </div>

                  <ScrollArea className="h-[350px]">
                    <div className="space-y-2">
                      {notesList.map((n) => (
                        <div key={n.id} className="p-3 border rounded bg-white">
                          {editingNoteId === n.id ? (
                            <div className="space-y-2">
                              <Input value={editNoteData.title} onChange={(e) => setEditNoteData({...editNoteData, title: e.target.value})} />
                              <Input value={editNoteData.pdf_url} onChange={(e) => setEditNoteData({...editNoteData, pdf_url: e.target.value})} />
                              <div className="flex gap-2">
                                <Button size="sm" onClick={handleSaveNoteEdit}><CheckCircle className="h-3 w-3 mr-1" /> Save</Button>
                                <Button size="sm" variant="ghost" onClick={() => setEditingNoteId(null)}>Cancel</Button>
                              </div>
                            </div>
                          ) : (
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="font-medium text-sm">{n.title}</p>
                                <p className="text-xs text-muted-foreground">{n.lessons?.title || "No lesson linked"}</p>
                              </div>
                              <div className="flex gap-1">
                                <Button size="icon" variant="ghost" onClick={() => { setEditingNoteId(n.id); setEditNoteData({ title: n.title, pdf_url: n.pdf_url }); }}>
                                  <Eye className="h-4 w-4" />
                                </Button>
                                <Button size="icon" variant="ghost" className="text-red-400" onClick={() => handleDeleteNote(n.id)}>
                                  <Trash2 className="h-4 w-4" />
                                </Button>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                      {notesList.length === 0 && <p className="text-center text-muted-foreground py-8">No notes yet.</p>}
                    </div>
                  </ScrollArea>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

        </Tabs>
      </main>
    </div>
  );
};

export default Admin;
